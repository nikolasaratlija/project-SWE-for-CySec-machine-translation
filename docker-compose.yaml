services:
  nginx:
    image: nginx:latest
    container_name: nginx_proxy
    ports:
      - "8080:80"    # For the HTTP to HTTPS redirect
      - "443:443"  # For the main HTTPS traffic
    volumes:
      # Mount our custom config file
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      # Mount the certificates (read-only for security)
      - ./certs/fullchain.pem:/etc/ssl/certs/fullchain.pem:ro
      - ./certs/privkey.pem:/etc/ssl/private/privkey.pem:ro
    depends_on:
      - api-gateway

  api-gateway:
    build: ./api-gateway
    ports:
      - "5000:5000" # exposed for debugging
    volumes:
      - ./api-gateway:/app
    environment:
      - AUTH_SERVICE_URL=http://auth-service:5001
      - TRANSLATION_SERVICE_URL=http://translation-service:5002
    depends_on:
      - auth-service
      - translation-service

  auth-service:
    build: ./auth-service
    ports:
      - "5001:5001" # exposed for debugging
    volumes:
      - ./auth-service:/app
    environment:
      - DATABASE_URL=postgresql://user:password@db-auth:5432/auth_db
      - JWT_SECRET_KEY=my-super-secret-key-that-should-be-in-a-vault
      - FLASK_APP=app.py
    depends_on:
      db-auth:
        condition: service_healthy

  translation-service:
    build: ./translation-service
    ports:
      - "5002:5002" # exposed for debugging
    volumes:
      - ./translation-service:/app
    environment:
      - DATABASE_URL=postgresql://user:password@db-translation:5432/translation_db
      - FLASK_APP=app.py
      - OLLAMA_API_URL=http://ollama:11434/api/generate
    depends_on:
      db-translation:
        condition: service_healthy
      ollama-setup:
        condition: service_completed_successfully

  db-auth:
    image: postgres:13
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=auth_db
    volumes:
      - auth_db_data:/var/lib/postgresql/data/
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d auth_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  db-translation:
    image: postgres:13
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=translation_db
    volumes:
      - translation_db_data:/var/lib/postgresql/data/
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d translation_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  ollama:
    image: ollama/ollama
    ports:
      - "11434:11434" # exposed for debugging
    volumes:
      - ollama_data:/root/.ollama

  ollama-setup:
    image: appropriate/curl
    command: >
      sh -c "
      echo 'Waiting for Ollama to be ready...' &&
      until curl -s http://ollama:11434 > /dev/null; do
        sleep 1
      done &&
      echo 'Ollama is ready. Pulling model...' &&
      curl http://ollama:11434/api/pull -d '{\"name\": \"llama3\"}' &&
      echo 'Model pulled successfully.'
      "
    depends_on:
      - ollama

volumes:
  auth_db_data:
  translation_db_data:
  ollama_data: